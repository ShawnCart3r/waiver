<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>No Boundaries 2025 Registration</title>
  <style>
    :root {
      /* Palette */
      --bg: #f6f7fb;
      --card: #ffffff;
      --border: #e7e8ef;
      --line: #e7e8ef;
      --text: #1f2430;
      --muted: #6a7280;

      /* Brand */
      --primary: #4a63e7;
      --primary-600: #4158dc;
      --primary-700: #3547b6;
      --primary-50:  #eef1ff;

      /* Accents & states */
      --ok: #28a745;
      --warn: #f4a100;
      --danger: #e64b4b;

      /* Elevation & radii */
      --radius: 14px;
      --radius-sm: 10px;
      --shadow-1: 0 4px 18px rgba(21, 28, 50, 0.08);
      --shadow-2: 0 10px 30px rgba(21, 28, 50, 0.10);

      /* Rhythm */
      --space-1: 6px;
      --space-2: 10px;
      --space-3: 14px;
      --space-4: 18px;
      --space-5: 24px;
      --space-6: 32px;

      /* Form sizing */
      --field-h: 46px;
      --font: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }

    body {
      font-family: var(--font);
      background:
        radial-gradient(1400px 800px at 10% -10%, rgba(74,99,231,0.06), transparent 60%),
        linear-gradient(180deg, #f9faff 0%, #f6f7fb 100%);
      color: var(--text);
      margin: 0;
      line-height: 1.55;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .container {
      max-width: 760px;
      margin: min(6vh, 48px) auto;
      padding: clamp(16px, 3vw, 28px);
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow-2);
      overflow: hidden;
      padding: clamp(16px, 3vw, 28px);
    }

    h1 {
      margin: 0 0 var(--space-3);
      text-align: center;
      font-size: clamp(22px, 3.2vw, 34px);
      letter-spacing: .2px;
      color: var(--primary-700);
    }
    .subhead {
      text-align: center;
      color: var(--muted);
      margin: -6px 0 var(--space-5);
      font-size: 0.98rem;
    }

    fieldset {
      border: 1px solid var(--border);
      background: linear-gradient(180deg, #ffffff 0%, #fbfcff 100%);
      border-radius: var(--radius);
      padding: var(--space-5);
      margin: 0 0 var(--space-6);
      box-shadow: var(--shadow-1);
      position: relative;
    }

    legend {
      margin-left: 8px;
      padding: 6px 10px;
      font-weight: 700;
      font-size: 1rem;
      color: var(--primary-700);
      background: linear-gradient(180deg, #fff, #f7f8ff);
      border: 1px solid var(--border);
      border-radius: 999px;
      box-shadow: 0 4px 10px rgba(74,99,231,0.08);
    }

    label {
      display: block;
      margin: var(--space-2) 0 var(--space-1);
      font-size: 0.96rem;
      font-weight: 600;
      color: #30384a;
    }
    .row { display: grid; gap: var(--space-2); }

    input, select, textarea {
      width: 100%;
      height: var(--field-h);
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      background: #ffffff;
      color: var(--text);
      font-size: 1rem;
      transition: border-color .15s ease, box-shadow .15s ease, background .15s ease;
      outline: none;
    }
    textarea { min-height: 110px; height: auto; resize: vertical; }

    input::placeholder, textarea::placeholder { color: #9aa3b2; }

    input:focus, select:focus, textarea:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(74,99,231,0.15);
      background: #fff;
    }

    .grid { display: grid; gap: var(--space-4); }
    @media (min-width: 640px) {
      .grid.two { grid-template-columns: repeat(2, 1fr); }
      .grid.three { grid-template-columns: repeat(3, 1fr); }
    }

    .checkbox-group {
      margin-top: var(--space-2);
      display: grid;
      gap: 8px;
    }
    .checkbox-group label {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 500;
      margin: 0;
      padding: 10px 12px;
      border: 1px dashed var(--border);
      border-radius: 12px;
      background: #fff;
    }
    input[type="checkbox"], input[type="radio"] {
      width: 18px; height: 18px; min-width: 18px;
      accent-color: var(--primary);
    }

    .hint { color: var(--muted); font-size: 0.9rem; margin-top: 6px; }
    .error-message { color: var(--danger); font-size: 0.9rem; margin-top: 6px; }
    .is-invalid { border-color: var(--danger) !important; box-shadow: 0 0 0 4px rgba(230,75,75,0.12) !important; }

    .status {
      margin-top: var(--space-3);
      text-align: center;
      font-weight: 600;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #fff;
      color: var(--muted);
    }
    .status.success { color: #146c2e; background: #ecfbf1; border-color: #c9f1d6; }
    .status.error   { color: #7c1f1f; background: #ffefef; border-color: #ffd9d9; }
    .status.warn    { color: #6b4a00; background: #fff7e7; border-color: #ffe5b0; }

    .actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
      margin-top: var(--space-4);
    }

    button {
      appearance: none;
      border: none;
      border-radius: 12px;
      padding: 12px 18px;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      transition: transform .05s ease, box-shadow .2s ease, background .2s ease;
      min-height: 44px;
    }
    button:active { transform: translateY(1px); }

    .btn-primary {
      background: linear-gradient(180deg, var(--primary) 0%, var(--primary-600) 100%);
      color: #fff;
      box-shadow: 0 8px 18px rgba(74,99,231,0.25), inset 0 1px 0 rgba(255,255,255,0.25);
    }
    .btn-primary:hover { background: linear-gradient(180deg, var(--primary-600), var(--primary-700)); }

    .btn-secondary {
      background: #fff;
      color: var(--text);
      border: 1px solid var(--border);
    }
    .btn-secondary:hover { background: var(--primary-50); }

    #retryBtn {
      display: none;
      background: #737b8c;
      color: #fff;
    }
    #retryBtn:hover { background: #5c6373; }

    @media (max-width: 560px) {
      .actions {
        position: sticky;
        bottom: 0;
        background: linear-gradient(180deg, rgba(246,247,251,0), #f6f7fb 45%);
        padding-bottom: 8px;
        z-index: 5;
      }
      .container { padding: 16px; }
      fieldset { padding: var(--space-4); }
    }

    hr { border: none; border-top: 1px dashed var(--border); margin: var(--space-5) 0; }
    small, .small { font-size: 0.88rem; color: var(--muted); }

    :focus-visible {
      outline: 3px solid rgba(74,99,231,0.35);
      outline-offset: 2px;
      border-radius: 12px;
    }

    @media (prefers-reduced-motion: reduce) { * { animation: none !important; transition: none !important; } }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #0f1220;
        --card: #13162a;
        --border: #2a2f46;
        --text: #e9edff;
        --muted: #aab2cf;
        --primary-50: #242a55;
      }
      body {
        background:
          radial-gradient(1200px 700px at 10% -10%, rgba(74,99,231,0.12), transparent 60%),
          linear-gradient(180deg, #0f1220, #0e1120);
      }
      .card, fieldset { box-shadow: 0 14px 36px rgba(0,0,0,0.35); }
      legend { background: linear-gradient(180deg, #181c33, #14182b); color: #bfc9ff; border-color: #2a2f46; }
      input, select, textarea { background: #11162a; border-color: #2a2f46; color: #e9edff; }
      input::placeholder, textarea::placeholder { color: #8c95b7; }
      .btn-secondary { background: #151a31; color: #e9edff; border-color: #2a2f46; }
      .status { background: #141a33; border-color: #2a2f46; color: #c9d2ff; }
      .status.success { background: #0f2a1a; border-color: #245738; color: #bdf3d0; }
      .status.error { background: #2a1414; border-color: #5a2a2a; color: #ffd0d0; }
      .status.warn { background: #2a2210; border-color: #5a4a1a; color: #ffe7b3; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>No Boundaries 2025 Registration</h1>

      <form id="regForm">
        <!-- Contact -->
        <fieldset>
          <legend>Contact Information</legend>
          <label>First Name <input type="text" name="firstName" required></label>
          <label>Last Name <input type="text" name="lastName" required></label>
          <label>Email <input type="email" name="email" required></label>
          <div class="grid two">
            <label>Street <input type="text" name="street"></label>
            <label>Town <input type="text" name="town"></label>
          </div>
          <div class="grid three">
            <label>State <input type="text" name="state" maxlength="2" placeholder="VT"></label>
            <label>Zip <input type="text" name="zip" inputmode="numeric" placeholder="12345"></label>
            <label>Phone <input type="tel" name="phone" placeholder="(555) 555-5555"></label>
          </div>
        </fieldset>

        <!-- Emergency Contact -->
        <fieldset>
          <legend>Emergency Contact</legend>
          <div class="grid two">
            <label>Contact Name <input type="text" name="ecName" required></label>
            <label>Contact Phone <input type="tel" name="ecPhone" required></label>
          </div>
        </fieldset>

        <!-- Programs -->
        <fieldset>
          <legend>Programs</legend>
          <div class="checkbox-group">
            <label><input type="checkbox" name="programs" value="5k-walk"> 5k Walk</label>
            <label><input type="checkbox" name="programs" value="beginner-5k-run"> Beginner 5k Run</label>
            <label><input type="checkbox" name="programs" value="10k"> 10k Run</label>
          </div>
        </fieldset>

        <!-- Age -->
        <fieldset>
          <legend>Age</legend>
          <div class="checkbox-group" style="border:0; background:transparent; padding:0;">
            <label style="border-style:solid;">
              <input type="radio" name="ageType" value="adult" checked> Adult (18+)
            </label>
            <label style="border-style:solid;">
              <input type="radio" name="ageType" value="minor"> Minor (under 18)
            </label>
          </div>
        </fieldset>

        <!-- Guardian (conditional) -->
        <fieldset id="guardianFields" style="display:none;">
          <legend>Parent or Guardian Information</legend>
          <div class="grid three">
            <label>Parent/Guardian Signature <input type="text" name="guardSig"></label>
            <label>Print Name <input type="text" name="guardName"></label>
            <label>Date <input type="date" name="guardDate"></label>
          </div>
          <p class="hint">These fields are required only if the participant is a minor.</p>
        </fieldset>

        <!-- Waiver -->
        <fieldset>
          <legend>Waiver &amp; Release of Liability</legend>
          <div class="row">
            <div id="waiverText" class="small" style="max-height:220px; overflow:auto; padding:12px; border:1px dashed var(--border); border-radius:12px; background:#fff;">
              <p><strong>Individual Event Participation Waiver and Release of Liability</strong></p>
              <p>Individual as listed below (a “Participant”) desires to enter and participate in No Boundaries Fall 2025 (the “Event”), hosted by Fleet Feet Vermont (the “Event Director”). By signing below, and in consideration of the Released Parties (defined herein) accepting this entry and allowing them to participate in the Event and as a condition for entry and participation in the Event, Participant agrees to all the terms and conditions of this waiver and release (“Release”).</p>
              <p>Participant, for themselves and their heirs, successors, and assigns, hereby waive, release, and forever discharge, Event Director, the participating Fleet Feet franchised business, Fleet Feet, Incorporated, and their respective parents, affiliates, subsidiaries, successors and assigns, shareholders, members, partners, officers, directors, managers, agents, employees, contractors, representatives, and volunteers (collectively, the “Released Parties”), from any and all claims, responsibilities or liability, now known or hereafter known, arising from injuries, disability, death, or damages to them or their personal property (including but not limited to any pets each Participant may bring to the Event) resulting from their participation in the Event or receipt of any prize, whether arising out of the ordinary negligence of the Released Parties or otherwise. Each Participant agrees not to file a suit, complaint, or grievance or make any claims against the Released Parties before any arbitration organization, in any local, state, or federal court, or administrative office on account of any injuries, disability, death, or damages covered herein. Each Participant forever releases and discharges the Released Parties from liability under such claims. It is the mutual intention of the Participant and the Released Parties that this release be general in scope and effect and that any claims arising in relation to participation in the Event, past, present or future, and asserted against the Released Parties are hereby forever canceled and forgiven.</p>
              <p><strong>RISKS:</strong> Participant is aware and understands that training, running, working out, and participating in the Event is each a potentially dangerous activity and involves the risk of injury, disability, death, or damages to the Participant or Participant’s property…</p>
              <p>In the event of an illness, injury, or medical emergency arising during the event, Participant hereby authorizes and gives their consent to any medical treatment deemed necessary…</p>
              <p>This Release constitutes the sole and entire agreement… governed by the laws of the State of Vermont… Essex Junction, VT…</p>
              <p><em>BY SIGNING THIS RELEASE, PARTICIPANT ACKNOWLEDGES THAT PARTICIPANT HAS READ AND AGREED TO THE ABOVE TERMS. PARTICIPANT IS VOLUNTARILY GIVING UP SUBSTANTIAL LEGAL RIGHTS, INCLUDING THE RIGHT TO SUE THE RELEASED PARTIES.</em></p>
            </div>
          </div>
          <div class="checkbox-group" style="margin-top:var(--space-3);">
            <label style="border-style:solid;">
              <input type="checkbox" name="waiverAgree" required> I have read and agree to the Waiver &amp; Release.
            </label>
          </div>
          <div class="grid two">
            <label>Initials <input type="text" name="waiverInitials" maxlength="4" placeholder="ABC" required></label>
          </div>
        </fieldset>

        <!-- Actions -->
        <div class="actions">
          <button type="submit" class="btn-primary">Submit Registration</button>
          <button id="retryBtn" type="button" class="btn-secondary">Retry Pending</button>
        </div>
        <div class="status" id="formStatus"></div>
      </form>
    </div>
  </div>

  <script>
    // Your deployed Apps Script Web App URL (exec)
    const SHEET_ENDPOINT = "https://script.google.com/macros/s/AKfycbxZQ2r5y_ug47dUaMklBdjVBbaUNmU8tXovK-E_PVepz9uaOd1EpIpiT_jR3g4xuvyAig/exec";

    const form = document.getElementById("regForm");
    const statusEl = document.getElementById("formStatus");
    const retryBtn = document.getElementById("retryBtn");
    const QUEUE_KEY = "nb2025_queue";

    // ----- Age/Guardian dynamic required -----
    const ageAdult = form.querySelector('input[name="ageType"][value="adult"]');
    const ageMinor = form.querySelector('input[name="ageType"][value="minor"]');
    const guardianFS = document.getElementById("guardianFields");
    const guardInputs = guardianFS.querySelectorAll('input[name="guardSig"], input[name="guardName"], input[name="guardDate"]');

    function toggleGuardian() {
      if (ageMinor.checked) {
        guardianFS.style.display = "block";
        guardInputs.forEach(i => i.required = true);
      } else {
        guardianFS.style.display = "none";
        guardInputs.forEach(i => i.required = false);
      }
    }
    ageAdult.addEventListener("change", toggleGuardian);
    ageMinor.addEventListener("change", toggleGuardian);
    toggleGuardian(); // run on load

    // ----- Offline queue helpers -----
    function enqueue(entry){
      const q = JSON.parse(localStorage.getItem(QUEUE_KEY) || "[]");
      q.push(entry);
      localStorage.setItem(QUEUE_KEY, JSON.stringify(q));
    }
    function dequeueAll(){
      const q = JSON.parse(localStorage.getItem(QUEUE_KEY) || "[]");
      localStorage.removeItem(QUEUE_KEY);
      return q;
    }
    function hasQueue(){
      return (JSON.parse(localStorage.getItem(QUEUE_KEY) || "[]").length > 0);
    }
    function showRetryIfNeeded(){
      retryBtn.style.display = hasQueue() ? "inline-block" : "none";
      if (hasQueue()) {
        const n = JSON.parse(localStorage.getItem(QUEUE_KEY)).length;
        retryBtn.textContent = `Retry Pending (${n})`;
      }
    }
    function fdToObj(fd){
      const obj={};
      fd.forEach((v,k)=>{
        if (obj[k]) { Array.isArray(obj[k]) ? obj[k].push(v) : obj[k] = [obj[k], v]; }
        else obj[k]=v;
      });
      return obj;
    }

    async function postWithRetry(fd, tries = 0){
      const max = 3;
      try{
        await fetch(SHEET_ENDPOINT, { method: "POST", body: fd, mode: "no-cors" });
        return { ok: true };
      }catch(e){
        if (tries >= max) throw e;
        await new Promise(r=>setTimeout(r, 800 * (2 ** tries)));
        return postWithRetry(fd, tries+1);
      }
    }

    // ----- Submit handler -----
    form.addEventListener("submit", async (e)=>{
      e.preventDefault();

      // Native HTML validation first (covers guardian fields when minor)
      if (!form.checkValidity()) {
        // Let the browser show which fields need attention
        form.reportValidity();
        return;
      }

      const fd = new FormData(form);

      // Normalize programs to multiple keys
      const programs = Array.from(form.querySelectorAll('input[name="programs"]:checked')).map(i=>i.value);
      fd.delete("programs");
      programs.forEach(v=>fd.append("programs", v));

      // Required by Apps Script handler
      if (!fd.get("_ts"))         fd.append("_ts", Date.now().toString());
      if (!fd.get("submittedAt")) fd.append("submittedAt", new Date().toISOString());
      if (!fd.get("website"))     fd.append("website", ""); // honeypot empty

      const submitBtn = form.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      submitBtn.textContent = "Submitting…";

      try{
        if(!navigator.onLine){
          enqueue(fdToObj(fd));
          statusEl.className = "status success";
          statusEl.textContent = "Saved offline. We’ll auto-send when you’re back online.";
          form.reset();
          toggleGuardian();
        } else {
          await postWithRetry(fd);
          statusEl.className = "status success";
          statusEl.textContent = "Thanks! Your registration has been submitted.";
          form.reset();
          toggleGuardian();
        }
      }catch(err){
        enqueue(fdToObj(fd));
        statusEl.className = "status error";
        statusEl.textContent = "Couldn’t reach server. Saved offline; retry later.";
      }finally{
        submitBtn.disabled = false;
        submitBtn.textContent = "Submit Registration";
        showRetryIfNeeded();
      }
    });

    // ----- Retry button -----
    retryBtn.addEventListener("click", async ()=>{
      const pending = dequeueAll();
      const remain = [];
      for (const entry of pending){
        const fd = new FormData();
        Object.entries(entry).forEach(([k,v])=>{
          if (Array.isArray(v)) v.forEach(x=>fd.append(k,x));
          else fd.append(k,v);
        });
        try{ await postWithRetry(fd); }catch(e){ remain.push(entry); }
      }
      if (remain.length) localStorage.setItem(QUEUE_KEY, JSON.stringify(remain));
      showRetryIfNeeded();
      statusEl.className = remain.length ? "status warn" : "status success";
      statusEl.textContent = remain.length ? `Retry finished. ${remain.length} left.` : "All pending submissions sent.";
    });

    window.addEventListener("load", showRetryIfNeeded);
  </script>
</body>
</html>
